<h1 align="center">去中心化数据交易应用框架</h1>
<p align="center" class="version">Version 0.8.0 </p>

## 概述

针对目前中心化数据交易所的痛点如：数据缓存、隐私数据未经用户授权、数据版权无法保护等问题，本体提出分布式数据管理协议ONT DATA，并基于此协议推出去中心化数据交易框架DDXF。本体生体应用开发者可以基于DDXF开发满足各种细分场景需求和各具特色的去中心化数据交易应用，并支持数据交易平台之间交易互通。

DDXF基于Ontology BlockChain，通过一致性账本、智能合约、密码学技术完美实现数字资产去中心化交易。DDXF提供一系列智能合约模板、交易组件和密码学组件，上层应用可以非常方便地实现版权控制、契约式数据分享等场景需求。

DDXF提供的主要功能包括：

* 数据资产化DataToken
* 数据交易智能合约eXchange Smart Contract
* 数据交易SDK
* 一系列密码学组件（如：数据水印）

![](http://on-img.com/chart_image/5b9b529de4b0fe81b63605f9.png)

## 名称定义

| 术语           | 描述                                       | 
| ------------ | ---------------------------------------- |
| 数据需求方         | 需要数据的机构/企业/个人                                  | 
| 数据提供方          | 提供数据的机构/企业/个人，数据可以是源数据，也可以是加工数据，数据提供需要完全满足当地政府的法律法规；                                   | 
| 资产化合约        | DatAsset Smart Contract，简写为 DSC。<br/>数据资产化，进一步上链，由智能合约支持。在合约中描述数据结构和资产化数据的合约，称为资产化合约。<br/>DSC 包含（但不限于）：DToken，发行人，评审人。 | 
| 资产化数据        | 由用户产生，具有价值的数据。任何数据都有可能成为资产化数据。包括数据、声明、证明等。<br/>资产化数据由资产元数据描述，通过资产化合约管理。<br/>也称“数据资产”。 | 
| 资产元数据        | Metadata，数据资产模板。<br/>对于资产化数据的数据结构和约束的描述。<br/>在资产化合约履行过程中根据资产元数据检验资产化数据。 | 
| 资产元数据规约      | 资产元数据（数据资产模板）的描述性语言。<br/>提供资产模板的格式、约束和语言范式。 | 
| 评审人          | 站在数据资产买方而言，对于数据的质量有一定的要求，仅靠买方代理无法保证数据质量。通过在合约预设评审人机制，在一定“可信”范围内保证数据质量。<br/>评审人可以是链内、链外；用户、角色用户集、评审小程序、AI等。 |       
| 交易合约         | eXchange Smart Contract，简写为 XSC。<br />DSC 发布的合约 Token（DToken），资产价值的计算直接通过 DToken 锚定。XSC 描述 DToken 到支付链上 Token（如，ONT）的兑换模式等。<br/>技术上参考交易所的相关解决方案。因此以“交易合约”命名此类合约。<br />简单交易合约考虑，<br />双 Token 兑换（DToken：ONT）；<br />二次提交（请求数据时买方预锁资产：数据交割后结算）；<br />双签（买方预签：卖方DToken签名凭证）。       |
| 去中心化数据交易所 |     DDXF的使用者，作为一个服务机构，主要工作包括：1、运营可视化的数据交易页面或社区 2、制定行业中的数据交易和交换标准，便于买卖双方以及交易参与方高效交易。各行各业数据交换标准会有很大差异性，所以将有各种不同类型的去中心化数据交易所。    | 



## 数据Token

DataToken（简称 DToken）是一个专门用于数据交换的智能合约，实现链外交换数据在链上的映射，从而能实现链上价值交割和链外数据交换的一致性。

DataToken中包括元数据MetaData，MetaData是对于资产化数据的数据结构和约束的描述。

在实例化DataToken过程中，将结合密码学组件，如数据水印等等，用于数据交易的追溯和版权追踪。

### 1.DToken设计初衷
DToken的目的是将任何的数据、实体Token化，DToken可以在DDXF交易，目前以NEP-5,ERC20为代表的Token都是“同质化Token”, 他无法将token和实体映射，DToken的定位是典型的“非同质化”token,即每一个token都是不同的，都有唯一的tokenId

目前的以太坊的[ERC721](https://github.com/ethereum/EIPs/blob/master/EIPS/eip-721.md),已经提出了这一标准,non-fungible tokens，简称NFT

### 2.为什么需要DataToken

在NEP-5代币中，每个代币的都是同样的，无法将一个Token和资产映射，谁控制了私钥，谁就拥有了这个Token,但是在现实中，房子、数据都是不同的，他们都有真正的Owner，具有不同的属性

### 3.DataToken可以支持评审人机制

在去中心化的场景中，对数据质量的评定，我们交给评审人设置，评审人可以为数据进行打分，从而影响数据交换的价值，甚至取消交易。具体规则在交易合约中实现。

### 4.DataToken合约 API设计

 * **mintToken**(owner, auditor, url): 发行DToken。
 * **name**(): Token名称
 * **symbol**(): Token符号
 * **balanceOf**(owner): 返回Owner当前所有的Dtoken
 * **totalSupply**(): 返回已发行Dtoken总量，数量会随着一直增加
 * **modifyURI**(tokenid, URI): 修改TokenURI
 * **tokenURI**(tokenid): 返回token映射实体物的位置
 * **ownerOf**(tokenid): 返回指定token的所有者
 * **transfer**(from, to, tokenid):交换Dtoken
 * **evaluate** (tokenid, ontid)：指定的ontid给tokenid打分
 * **getRating**(tokenid) （获取指定tokenid的打分)
 * **changeAuditor**(tokenid,ontid) （修改tokenid的打分人)
 


## 工作模式


![](http://on-img.com/chart_image/5a92878de4b059c41ac98e46.png)



## 基于智能合约“一手交钱，一手交货”

为了保证交易双方的权益，在协议的交易流程中引入一个作为“担保人”的中间方，保证“一手交钱，一手交货”的结算过程。该中间方负责保管买方的资金，并根据最终交易结果将该资金转给卖方或退回给买方。因为中间方负责交易的最终结算，必须具备足够的公正性与安全性。依托于分布式账本运作的智能合约，具有公开且去中心化管理的特点，十分适合承担中间方的角色。

此合约用于资金的锁定与分配。
合约接受用户账户输入的资金，锁定一定时间。在锁定期间内任何人无法动用这笔资金。锁定结束后按照指定的分配规则将资金分发给其他账户。


### 角色

合约涉及的三个角色：

* 付款人：创建实例，输入资金
* 收款人：由付款人指定，在锁定结束后取得资金
* 评审人：可选角色，由付款人指定，并需收款人确认，有权决定最终分配的资金额。


### 流程

资金锁定及分配的流程如下：

```
生成分配实例  锁定资金        锁定期限
   |----------|--------------|-------------
   |  设定参数 |   资金锁定     |  确认，触发分配
```

整个流程分为3个阶段

1. 付款人生成实例并设定参数、转入资金。若设定评审人，则收款人需在此阶段确认评审人信息。此阶段付款人可取消实例。
2. 付款人调用**锁定**接口，资金被锁定在合约中，任何人将无法操作实例中的资金。
3. 锁定期结束后，进入资金分配阶段。此阶段收付款双方任意一方确认，即可完成资金的分配，实例结束。
   * 若设置了评审人，则评审人需在收付款方确认前确定最终向收款人分配的资金额度，未分配的资金部分将退回给付款人。
   * 若设置了评审人，付款人可调用**退款**接口申请退款。需收款人或评审人也调用退款接口确认同意退款后，资金才能够退回。



## 数据交割设计

[进入了解](offchain-data-exchange.md)


## 数据交易组件DataRot

在链下数据交割过程中，为了保证数据的去中心化可信存储，原则上由数据提供方自行保存自己的数据，在进行链上数据DToken化时绑定数据URL。数据交易参与方可集成DataRot组件，由组件为提供方完成数据DToken化、DToken动作监听、权限管理及数据安全传输。


去中心化数据交易标准组件DataRot，可由数据提供方主动部署。ExDataClient作为数据提供方、数据需求方和区块链三者的交互桥梁，既要与链上智能合约交互又要与链下真实数据交互。需提供的标准功能包括：

- 数据链上DToken化
- DToken链上动作监听
- 请求方权限验证
- 数据加密安全传输

由于组件需要调链上智能合约发交易，数据提供方需要把自己的OntId和account.json账户文件配置在组件配置文件和目录中。

### 数据链上DToken化
ExDataClient组件提供标准Restful API替数据提供方完成本地数据在链上智能合约中的DToken化。数据提供方需提供dataName，dataPath，auditorOntId等信息。组件会生成唯一数据URL，获取配置的数据提供方OntId绑定到DToken中。
```
{
	"auditorOntId":"did:ont:T2nGst12KJ769n0N1GC7901n2",
	"dataName":"did_contract.abi",
	"dataPath":"/var/mydata/contract/"
}
```


### DToken链上消息监听
当实例化好DToken后，组件通过websocket订阅机制，监听该DToken的链上动作。
- 买单动作
当有数据需求方进行买单完成资金锁仓时，ExDataClient组件需监听该买单动作，更新DToken状态为"已下单"并获取需求方OntId，用于后续权限验证。
- 审核动作
当审核方做完数据审核，完成链上DToken打分时，ExDataClient组件需监听该打分动作，更新DToken状态为"已审核"并获取分数。
- 资金交割
当数据需求方进行订单确认，完成链上资金交割时。ExDataClient组件需监听该资金交割动作，更新DToken状态为"已交割"。


### 请求方权限验证
当进行链下数据请求时，请求方必须带上OntId，数据提供方的DToken标识以及自己的签名
```
{
	"ontId":"did:ont:TA4zNs7vk6MZwSY1FXHCZi5F9jnsgZ8fRq",
	"dToken":"0x8018jgf7645a84298a1a52aa3745f84dba6615cf",
	"siganture":"",
}
```

DataRot组件首先需检查该DToken的状态是否是"已审核"，然后再对请求签名进行验签，确认数据请求附带的OntId属于请求方。最后检查该OntId是否已经是DToken的属主。完成以上步骤才算权限验证通过。







